@page
@model ContactAppCore.Pages.JobEditModel
@{
}
<link rel="stylesheet" href="/css/quill.bubble.css" />
<h1 id="pageTitle">Edit Job Profile</h1>

<form id="profile" class="large">
    <input id="id" name="id" type="hidden" value="0" />
    <input id="officeId" name="officeId" type="hidden" value="0" />
    <div><label for="netid">Net ID:</label><input id="netid" name="netid" class="long" /><span id="netid-display"></span></div>
    <div><label for="title">Job Title:</label><input id="title" name="title" class="long" /></div>
    <div>
        <label for="category">Category:</label><select id="category" name="category">
            <option value="">Other</option>
            <option value="core-faculty">Core Faculty</option>
            <option value="faculty">Faculty</option>
            <option value="student">Stduent</option>
            <option value="staff">Staff</option>
            <option value="emeriti">Emeriti</option>
        </select>
    </div>
    <div>
        <label for="display">Display:</label><select id="display" name="display">
            <option value="">Directory Only</option>
            <option value="faculty-finder">Faculty Finder</option>
        </select>
    </div>
    <div>
        <label for="internalorder">Internal Order:</label><select id="internalorder" name="internalorder">
            <option value="3">Medium</option>
            <option value="1">High</option>
            <option value="5">Low</option>
        </select>
    </div>
    <div><label for="biography">Job-Specific Biography:</label><div id='biography' class='fulltext'></div></div>

    <button class="il-button" id="updateGeneral" onclick="return update();">Update Job Profile Information</button>
</form>

@section Scripts
{
    <script src="~/js/quill.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var quillInfo = new Quill('#biography', {
            modules: {
                toolbar: [
                    ['bold', 'italic', 'link', { 'list': 'ordered' }, { 'list': 'bullet' }, 'clean']
                ],
                keyboard: {
                    bindings: {
                        tab: {
                            key: 9,
                            handler: () => { document.getElementById('category').focus(); },
                        },
                        'remove tab': {
                            key: 9,
                            shiftKey: true,
                            collapsed: true,
                            prefix: /\t$/,
                            handler: () => { },
                        }
                    }
                }
            },
            placeholder: 'Enter the job-specific biography ...',
            theme: 'bubble'
        });

        function loadInformation() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (id == '0') {
                const officeId = urlParams.get('officeId');
                document.getElementById('officeId').value = officeId;
                document.getElementById('netid').disabled = false;
                document.getElementById('pageTitle').innerHTML = 'Add Job Profile';
                let updateButton = document.getElementById('updateGeneral');
                updateButton.innerHTML = 'Add Job Profile Information';
                updateButton.setAttribute('onclick', 'return add();');
            } else {
                fetch('/Api/Job/' + id, {
                    method: 'GET',
                    headers: {
                        "Content-type": "application/x-www-form-urlencoded; charset=UTF-8"
                    }
                }).then(res => res.json()).then(data => {
                    document.getElementById('netid').disabled = true;
                    document.getElementById('netid').style.display = 'none';
                    document.getElementById('netid-display').innerHTML = data.employeeNetId;
                    if (data != null) {
                        document.getElementById('id').value = data.id;
                        document.getElementById('title').value = data.title;
                        document.getElementById('internalorder').value = data.internalOrder;
                        if (data.biography != null) {
                            quillInfo.setContents(quillInfo.clipboard.convert(data.biography), 'silent');
                        }
                        data.tags.forEach(t => {
                            if (t.title == 'faculty-finder') {
                                document.getElementById('display').value = 'faculty-finder';
                            } else {
                                document.getElementById('category').value = t.title;
                            }
                        });
                    } else {
                        document.getElementById('id').value = '0';
                    }
                });
            }
        }

        function update() {
            let object = {};
            object['id'] = document.getElementById('id').value;
            object['biography'] = cleanQuill(quillInfo.root.innerHTML);
            debugger;
            object['title'] = document.getElementById('title').value;
            document.querySelectorAll('#profile select').forEach(p => object[p.name] = p.value);
            var json = JSON.stringify(object);
            fetch('/Api/EditJob/Update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: json
            });
            return false;
        }

        function add() {
            let object = {};
            object['officeId'] = document.getElementById('officeId').value;
            object['biography'] = cleanQuill(quillInfo.root.innerHTML);
            object['netid'] = document.getElementById('netid').value;
            object['title'] = document.getElementById('title').value;
            document.querySelectorAll('#profile select').forEach(p => object[p.name] = p.value);
            var json = JSON.stringify(object);
            fetch('/Api/EditJob/Add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: json
            });
            return false;
        }

        function cleanQuill(s) {
            if (s == '<br />' || s == '<br>' || s == '<p><br></p>') {
                return '';
            }
            return s;
        }

        document.addEventListener('DOMContentLoaded', function (event) {
            loadInformation();
        });
    </script>
}